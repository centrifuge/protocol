name: Verify Factory Contracts

on:
  push:  # TODO: remove before merging
  workflow_dispatch:
    inputs:
      source_version:
        description: "Git tag of the deployed source code (e.g. v3.1.0). src/ will be checked out from this tag so forge verify-contract uses matching bytecode."
        required: true
        default: "v3.1.0"

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Checkout src/ from deployed version
        run: git checkout ${{ inputs.source_version || 'v3.1.0' }} -- src/

      - id: "auth"
        uses: "google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f" # v2.1.7
        with:
          workload_identity_provider: ${{ secrets.GCP_WIP }}
          service_account: ${{ secrets.GCP_SA }}
          create_credentials_file: true
          cleanup_credentials: true

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@6189d56e4096ee891640bb02ac264be376592d6a" # v2.1.2
        with:
          version: ">= 363.0.0"

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: v1.4.4

      - name: Load secrets
        run: python3 script/deploy/load_secrets.py

      - name: Mask secrets
        run: |
          while IFS='=' read -r key value; do
            [[ -z "$key" || "$key" == \#* || -z "$value" ]] && continue
            echo "::add-mask::$value"
          done < .env

      - name: Verify all networks
        run: |
          networks=(
            ethereum
            base
            arbitrum
            avalanche
            bnb-smart-chain
            optimism
            plume
            hyper-evm
            monad
            sepolia
            base-sepolia
            arbitrum-sepolia
            hyper-evm-testnet
          )
          for network in "${networks[@]}"; do
            echo "========== Verifying $network =========="
            NETWORK=$network forge script script/VerifyFactoryContracts.s.sol -vv || true
          done
