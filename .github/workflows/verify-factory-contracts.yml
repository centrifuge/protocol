name: Verify Factory Contracts

on:
  push:  # TODO: remove before merging
  workflow_dispatch:
    inputs:
      source_version:
        description: "Git tag of the deployed source code (e.g. v3.1.0). src/ will be checked out from this tag so forge verify-contract uses matching bytecode."
        required: true
        default: "v3.1.0"

jobs:
  setup:
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"
    outputs:
      networks: ${{ steps.list.outputs.networks }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Checkout src/ from deployed version
        run: git checkout ${{ inputs.source_version || 'v3.1.0' }} -- src/

      - name: List networks from env/*.json
        id: list
        run: |
          networks=$(ls env/*.json | xargs -n1 basename | sed 's/.json//' | grep -v anvil | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "networks=$networks" >> "$GITHUB_OUTPUT"
          echo "Discovered networks: $networks"

      - id: "auth"
        uses: "google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f" # v2.1.7
        with:
          workload_identity_provider: ${{ secrets.GCP_WIP }}
          service_account: ${{ secrets.GCP_SA }}
          create_credentials_file: true
          cleanup_credentials: true

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@6189d56e4096ee891640bb02ac264be376592d6a" # v2.1.2
        with:
          version: ">= 363.0.0"

      - name: Load secrets
        run: python3 script/deploy/load_secrets.py

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: v1.4.4

      - name: Compile contracts
        run: forge build

      - name: Package workspace
        run: tar czf /tmp/workspace.tar.gz --exclude=.git .

      - name: Upload workspace
        uses: actions/upload-artifact@v4
        with:
          name: workspace
          path: /tmp/workspace.tar.gz
          retention-days: 1

  verify:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        network: ${{ fromJson(needs.setup.outputs.networks) }}

    name: "${{ matrix.network }}"

    steps:
      - name: Download workspace
        uses: actions/download-artifact@v4
        with:
          name: workspace

      - name: Extract workspace
        run: tar xzf workspace.tar.gz && rm workspace.tar.gz

      - name: Mask secrets
        run: |
          while IFS='=' read -r key value; do
            [[ -z "$key" || "$key" == \#* || -z "$value" ]] && continue
            echo "::add-mask::$value"
          done < .env

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: v1.4.4

      - name: Verify ${{ matrix.network }}
        env:
          NETWORK: ${{ matrix.network }}
        run: forge script script/VerifyFactoryContracts.s.sol -vv
